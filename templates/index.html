<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Analyze - í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* 1. ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid #764ba2; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 2. íƒ­ ì „í™˜ ìŠ¤íƒ€ì¼ */
        .content-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 3. ì•Œë¦¼ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .flash-container {
            position: fixed; top: 20px; right: 20px; z-index: 1000; width: 300px;
        }
        .flash-message {
            background: #fff; color: #333; padding: 15px 20px; margin-bottom: 10px;
            border-left: 5px solid #764ba2; border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.95em; opacity: 1; transition: opacity 0.5s;
        }

        /* 4. ë§ˆì´í˜ì´ì§€ ë° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .history-item {
            background: #f8f9fa; border: 1px solid #eee; border-radius: 8px;
            padding: 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; }
        .badge-high { background-color: #e74c3c; }   /* ìœ„í—˜ */
        .badge-mid { background-color: #f39c12; }    /* ì£¼ì˜ */
        .badge-low { background-color: #27ae60; }    /* ì•ˆì „ */

        /* ë…¹ìŒê¸° ìŠ¤íƒ€ì¼ */
        .record-timer { font-size: 1.2em; font-weight: bold; color: #e74c3c; margin-left: 10px; display: none; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3>AIê°€ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
        <p style="color: #666;">íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì•½ 10~30ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="flash-container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for msg in messages %}
                    <div class="flash-message">{{ msg }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo-text-sidebar">Voice Analyze</h1>
                <p class="service-name-sidebar">ğŸ¶ ìŒì•… í‘œì ˆ ê²€ì‚¬ê¸°</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" class="nav-item active" onclick="showTab('home', this)"><i class="fas fa-home"></i> í™ˆ</a></li>
                    <li><a href="#" class="nav-item" onclick="showTab('plagiarism', this)"><i class="fas fa-magnifying-glass-chart"></i> ë…¸ë˜ í‘œì ˆ ê²€ì‚¬</a></li>
                    <li><a href="#" class="nav-item" onclick="showTab('cover', this)"><i class="fas fa-music"></i> ì»¤ë²„ê³¡ ê²€ì‚¬</a></li>
                    <li><a href="#" class="nav-item" onclick="showTab('record', this)"><i class="fas fa-microphone-alt"></i> ìŒì„± ë…¹ìŒê¸°</a></li>
                    <li class="separator"></li>
                    <li><a href="#" class="nav-item" onclick="showTab('mypage', this)"><i class="fas fa-user"></i> ë‚´ í˜ì´ì§€</a></li>
                    <li><a href="{{ url_for('logout') }}" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content-area">
            
            <section id="home" class="content-section active">
                <div class="card wide-card" style="text-align: center; padding: 60px 20px;">
                    <h2>ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, <strong>{{ username }}</strong>ë‹˜!</h2>
                    <p style="color: #666; margin-top: 15px; line-height: 1.6;">
                        <strong>Voice Analyze</strong> ì„œë¹„ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>
                        ì™¼ìª½ ë©”ë‰´ë¥¼ í†µí•´ í‘œì ˆ ê²€ì‚¬, ì»¤ë²„ê³¡ ë¶„ì„, ìŒì„± ë…¹ìŒ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.<br>
                        ëª¨ë“  ë¶„ì„ ê²°ê³¼ëŠ” 'ë‚´ í˜ì´ì§€'ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>
                    <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
                        <button class="detect-btn" onclick="showTab('plagiarism')">í‘œì ˆ ê²€ì‚¬í•˜ëŸ¬ ê°€ê¸°</button>
                        <button class="detect-btn secondary-btn" onclick="showTab('cover')">ì»¤ë²„ê³¡ ë¶„ì„í•˜ê¸°</button>
                    </div>
                </div>
            </section>

            <section id="plagiarism" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-waveform"></i></div>
                    <h3>ë…¸ë˜ í‘œì ˆ ê²€ì‚¬ê¸°</h3>
                    <p class="card-description">ê¸°ì¤€ì´ ë˜ëŠ” ì›ë³¸ íŒŒì¼ê³¼ í‘œì ˆì´ ì˜ì‹¬ë˜ëŠ” íŒŒì¼ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>
                    
                    <form action="/analyze-plagiarism" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                        <div class="input-file-group">
                            <input type="text" id="p1-name" placeholder="ê¸°ì¤€ ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('p1').click()">íŒŒì¼ ì°¾ê¸°</button>
                            <input type="file" id="p1" name="file1" style="display:none" accept=".mp3, .wav, .m4a, .flac" required onchange="updateFileName(this, 'p1-name')">
                        </div>
                        <div class="input-file-group">
                            <input type="text" id="p2-name" placeholder="ë¹„êµí•  ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('p2').click()">íŒŒì¼ ì°¾ê¸°</button>
                            <input type="file" id="p2" name="file2" style="display:none" accept=".mp3, .wav, .m4a, .flac" required onchange="updateFileName(this, 'p2-name')">
                        </div>
                        <button type="submit" class="detect-btn"><i class="fas fa-search"></i> í‘œì ˆ ë¶„ì„ ì‹œì‘</button>
                    </form>
                </div>
            </section>

            <section id="cover" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-music"></i></div>
                    <h3>ì»¤ë²„ê³¡ ìœ ì‚¬ë„ ê²€ì‚¬ê¸°</h3>
                    <p class="card-description">ì›ë³¸(MR/AR)ê³¼ ì‚¬ìš©ìê°€ ë¶€ë¥¸ ì»¤ë²„ê³¡ì˜ ìœ ì‚¬ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.</p>
                    
                    <form action="/analyze-cover" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                        <div class="input-file-group">
                            <input type="text" id="c1-name" placeholder="ì›ë³¸ MR/AR íŒŒì¼" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('c1').click()">íŒŒì¼ ì°¾ê¸°</button>
                            <input type="file" id="c1" name="file1" style="display:none" accept=".mp3, .wav, .m4a, .flac" required onchange="updateFileName(this, 'c1-name')">
                        </div>
                        <div class="input-file-group">
                            <input type="text" id="c2-name" placeholder="ë‚´ ì»¤ë²„ê³¡ íŒŒì¼" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('c2').click()">íŒŒì¼ ì°¾ê¸°</button>
                            <input type="file" id="c2" name="file2" style="display:none" accept=".mp3, .wav, .m4a, .flac" required onchange="updateFileName(this, 'c2-name')">
                        </div>
                        <button type="submit" class="detect-btn secondary-btn"><i class="fas fa-check-double"></i> ì»¤ë²„ê³¡ ë¶„ì„ ì‹œì‘</button>
                    </form>
                </div>
            </section>

            <section id="record" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-microphone-alt"></i></div>
                    <h3>ìŒì„± ë…¹ìŒê¸°</h3>
                    <p class="card-description">ëª©ì†Œë¦¬ë¥¼ ë…¹ìŒí•˜ì—¬ íŒŒì¼(.wav)ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <div class="record-controls" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button class="detect-btn" id="startRecordBtn" style="flex: 1;"><i class="fas fa-circle"></i> ë…¹ìŒ ì‹œì‘</button>
                        <button class="detect-btn secondary-btn" id="stopRecordBtn" style="flex: 1;" disabled><i class="fas fa-stop"></i> ë…¹ìŒ ì¤‘ì§€</button>
                    </div>
                    
                    <div id="playbackContainer" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <p style="font-weight: bold; margin-bottom: 10px;">ğŸ§ ë…¹ìŒ ë¯¸ë¦¬ë“£ê¸°</p>
                        <audio id="audioPlayback" controls style="width: 100%; margin-bottom: 15px;"></audio>
                        <a id="downloadLink" class="detect-btn" style="background-color: #28a745; display: block; text-align: center; text-decoration: none;">
                            <i class="fas fa-download"></i> ë…¹ìŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                </div>
            </section>

            <section id="mypage" class="content-section">
                <div class="card wide-card">
                    <h3>ğŸ‘¤ ë‚´ í˜ì´ì§€</h3>
                    <p style="color: #777; font-size: 0.9em;">ìµœê·¼ ë¶„ì„ ê¸°ë¡ê³¼ ê³„ì • ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                    
                    <h4><i class="fas fa-list"></i> ìµœê·¼ ë¶„ì„ ê¸°ë¡</h4>
                    <ul style="list-style: none; padding: 0; margin-top: 15px;">
                        {% if history %}
                            {% for item in history %}
                            <li class="history-item">
                                <div>
                                    <strong style="font-size: 1.05em; color: #333;">{{ item.result_msg }}</strong><br>
                                    <small style="color: #888;">
                                        <i class="far fa-clock"></i> {{ item.created_at.strftime('%Y-%m-%d %H:%M') }} | 
                                        íŒŒì¼: {{ item.file1_path.split('/')[-1] }}
                                    </small>
                                </div>
                                {% if item.similarity_score >= 80 %}
                                    <span class="badge badge-high">{{ item.similarity_score }}%</span>
                                {% elif item.similarity_score >= 50 %}
                                    <span class="badge badge-mid">{{ item.similarity_score }}%</span>
                                {% else %}
                                    <span class="badge badge-low">{{ item.similarity_score }}%</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        {% else %}
                            <li style="text-align: center; color: #999; padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endif %}
                    </ul>

                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

                    <h4><i class="fas fa-lock"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                    <form action="/change-password" method="POST" style="margin-top: 15px; background: #f9f9f9; padding: 20px; border-radius: 8px;">
                        <div class="input-form-group" style="margin-bottom: 10px;">
                            <input type="password" name="current_password" class="form-input-field" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" name="new_password" class="form-input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" required style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="password" name="confirm_password" class="form-input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button type="submit" class="detect-btn" style="margin-top: 15px; width: auto; padding: 10px 20px;">ë³€ê²½í•˜ê¸°</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <script>
        // 1. íƒ­ ì „í™˜ ë° ìœ ì§€ í•¨ìˆ˜ (ìƒˆë¡œê³ ì¹¨ í•´ë„ ìœ ì§€ë¨)
        function showTab(tabId, element) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            // ì„ íƒí•œ ì„¹ì…˜ ë³´ì„
            document.getElementById(tabId).classList.add('active');
            
            // ë©”ë‰´ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // í´ë¦­í•œ ë©”ë‰´ í™œì„±í™” (ë²„íŠ¼ í´ë¦­ ì‹œ elementê°€ ì—†ì„ ìˆ˜ ìˆìŒ)
            if (element) {
                element.classList.add('active');
            } else {
                // ë²„íŠ¼ìœ¼ë¡œ ì´ë™í–ˆì„ ë•Œ ì‚¬ì´ë“œë°” ë©”ë‰´ë„ ê°™ì´ í™œì„±í™”
                const targetLink = Array.from(document.querySelectorAll('.nav-item'))
                    .find(el => el.getAttribute('onclick').includes(tabId));
                if(targetLink) targetLink.classList.add('active');
            }

            // í˜„ì¬ íƒ­ ì €ì¥
            localStorage.setItem('activeTab', tabId);
        }

        // 2. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // ì €ì¥ëœ íƒ­ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ home)
            const lastTab = localStorage.getItem('activeTab') || 'home';
            showTab(lastTab);

            // ì•Œë¦¼ ë©”ì‹œì§€ 3ì´ˆ í›„ ìë™ ì‚­ì œ
            const flashMsgs = document.querySelectorAll('.flash-message');
            if (flashMsgs.length > 0) {
                setTimeout(() => {
                    flashMsgs.forEach(msg => {
                        msg.style.opacity = '0';
                        setTimeout(() => msg.remove(), 500);
                    });
                }, 3000);
            }
        });

        // 3. íŒŒì¼ëª… ì—…ë°ì´íŠ¸ ë° í™•ì¥ì ê²€ì‚¬
        function updateFileName(input, targetId) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                // í™•ì¥ì ê²€ì‚¬ (ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ)
                if (!/\.(mp3|wav|m4a|flac|ogg)$/i.test(fileName)) {
                    alert("ì˜¤ë””ì˜¤ íŒŒì¼(.mp3, .wav ë“±)ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    input.value = ""; // ì„ íƒ ì´ˆê¸°í™”
                    document.getElementById(targetId).value = "";
                    return;
                }
                document.getElementById(targetId).value = fileName;
            }
        }

        // 4. ë¡œë”© í™”ë©´ í‘œì‹œ
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // 5. ë…¹ìŒê¸° ë¡œì§ (íƒ€ì´ë¨¸ í¬í•¨)
        const startBtn = document.getElementById('startRecordBtn');
        const stopBtn = document.getElementById('stopRecordBtn');
        let mediaRecorder;
        let audioChunks = [];
        let recordInterval;
        let recordTime = 0;

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    document.getElementById('audioPlayback').src = url;
                    
                    const downBtn = document.getElementById('downloadLink');
                    downBtn.href = url;
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[-:.]/g, "").slice(0, 15);
                    downBtn.download = `recording_${timestamp}.wav`;
                    
                    document.getElementById('playbackContainer').style.display = 'block';
                    audioChunks = [];
                };

                mediaRecorder.start();
                
                // UI ë³€ê²½
                startBtn.disabled = true;
                stopBtn.disabled = false;
                document.getElementById('playbackContainer').style.display = 'none';

                // íƒ€ì´ë¨¸ ì‹œì‘
                recordTime = 0;
                startBtn.innerHTML = '<i class="fas fa-circle" style="color:red; animation:blink 1s infinite;"></i> ë…¹ìŒ ì¤‘ (00:00)';
                
                recordInterval = setInterval(() => {
                    recordTime++;
                    const min = String(Math.floor(recordTime / 60)).padStart(2, '0');
                    const sec = String(recordTime % 60).padStart(2, '0');
                    startBtn.innerHTML = `<i class="fas fa-circle" style="color:red; animation:blink 1s infinite;"></i> ë…¹ìŒ ì¤‘ (${min}:${sec})`;
                }, 1000);

            } catch (e) {
                console.error(e);
                alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }
        };

        stopBtn.onclick = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                startBtn.disabled = false;
                stopBtn.disabled = true;
                clearInterval(recordInterval);
                startBtn.innerHTML = '<i class="fas fa-circle"></i> ë…¹ìŒ ì‹œì‘';
            }
        };
    </script>
</body>
</html>